English | [简体中文](../zh_CN/topic-rewrite.md)


# Topic Rewrite

Some older IoT devices do not support reconfiguration or upgrades, making it very challenging to modify the MQTT 
subscription topics. The topic rewriting feature in RMQTT allows you to set up a set of rules that can automatically 
rewrite the original topics to new target topics during subscription, unsubscription, or publication.


* Since the publish/subscribe authorization check is performed after topic rewriting, it's essential to ensure that 
the rewritten topics pass the ACL check.


* Topic rewriting, when applied to a client's subscription or unsubscription of shared subscription topics, only 
affects the actual topic. This means it only rewrites the portion of the shared subscription topic after removing 
the $share/group-name/ prefix. For example, when a client subscribes to or unsubscribes from the shared subscription 
topic filter $share/group/x/y/z, only x/y/z will be matched and rewritten, while $share/group/ will be ignored.


#### Configuring Topic Rewriting Rules

The topic rewriting rules in *RMQTT* need to be configured by the user, who can add multiple topic rewriting rules as needed.

The format for each topic rewriting rule is as follows:
```bash
rules = [
    { action = "all", source_topic_filter = "x/+/#", dest_topic = "xx/$1/$2", regex = "^x/(.+)/(.+)$" }
]
```

Each rewriting rule consists of a topic filter, a target expression, and a regular expression.


Topic rewriting rules are divided into `publish`, `subscribe`, and `all` rules. `publish` rules match the topics 
carried in PUBLISH packets, while `subscribe` rules match the topics carried in SUBSCRIBE and UNSUBSCRIBE packets. 
The `all` rules apply to the topics in PUBLISH, SUBSCRIBE, and UNSUBSCRIBE packets.

When topic rewriting is enabled, RMQTT will use the topic from the MQTT packet (e.g., a PUBLISH message with a topic) 
to match against the topic filter portion of the rules configured in the settings. If a match is found, a regular 
expression is used to extract information from the topic, and the old topic is replaced with a new one generated by 
the target expression.

The target expression can use variables in the format `$N` to match elements extracted from the regular expression. 
The value of `$N` refers to the Nth element extracted by the regular expression; for example, `$1` is the first 
element extracted.

Additionally, in the expression, `${clientid}` can be used to represent the client ID, and `${username}` can be used 
to represent the client username.

**Note:** RMQTT will use the topic filter configured in the rule to build the search topic tree. When a topic can match 
multiple topic filter rules, RMQTT will only use the last successfully matched rule to rewrite the topic.

If the regular expression in the rule does not match the topic in the MQTT packet, the rewriting will fail, and other 
rules will not be used for rewriting. Therefore, it is essential to carefully design the MQTT packet topics and topic 
rewriting rules.


#### Plugin:

```bash
rmqtt-topic-rewrite
```

#### Plugin Configuration File:

```bash
plugins/rmqtt-topic-rewrite.toml
```

#### Plugin Configuration Options:

```bash
##--------------------------------------------------------------------
## rmqtt-topic-rewrite
##--------------------------------------------------------------------

# action - Options are publish, subscribe, or all
# source_topic_filter - Topic filter for subscribing, unsubscribing, or publishing messages
# dest_topic - Destination topic
# regex - Regular expression

# Expressions can use ${clientid} to represent the client ID and ${username} to represent the client username.

rules = [
    { action = "all", source_topic_filter = "x/+/#", dest_topic = "xx/$1/$2", regex = "^x/(.+)/(.+)$" },
    { action = "all", source_topic_filter = "x/y/1", dest_topic = "xx/y/1" },
    { action = "all", source_topic_filter = "x/y/#", dest_topic = "xx/y/$1", regex = "^x/y/(.+)$" },
    { action = "all", source_topic_filter = "iot/cid/#", dest_topic = "iot/${clientid}/$1", regex = "^iot/cid/(.+)$" },
    { action = "all", source_topic_filter = "iot/uname/#", dest_topic = "iot/${username}/$1", regex = "^iot/uname/(.+)$" },
    { action = "all", source_topic_filter = "a/+/+/+", dest_topic = "aa/$1/$2/$3", regex = "^a/(.+)/(.+)/(.+)$" }
]
```

Six topic rewriting rules have been configured: `x/+/#`, `x/y/1`, `x/y/#`, `iot/cid/#`, `iot/uname/#`, and `a/+/+/+`.

- `z/def` does not match any topic filters, so no topic rewriting is performed; it just subscribes to or publishes the `z/def` topic.
- `x/a/z` matches the `x/+/#` topic filter. RMQTT applies the first rule, uses the regular expression to match the elements `[a, z]`, and replaces them using `xx/$1/$2`, resulting in an actual subscription or publication to the topic: `xx/a/z`.
- `x/y/1` matches the `x/+/#`, `x/y/#`, and `x/y/1` topic filters. The final match is `x/y/1`. Since no regular expression is configured, it actually subscribes to or publishes to the topic: `xx/y/1`.
- `x/y/2` matches the `x/+/#` and `x/y/#` topic filters. The final match is `x/y/#`. Through regular expression replacement, it actually subscribes to or publishes to the topic: `xx/y/2`.
- `iot/cid/1` matches the `iot/cid/#` topic filter. Through regular expression and `clientid` replacement, it actually subscribes to or publishes to the topic: `iot/cid001/1`.
- `iot/uname/1` matches the `iot/uname/#` topic filter. Through regular expression and `username` replacement, it actually subscribes to or publishes to the topic: `iot/uname001/1`.
- `a/1/2/3` matches the `a/+/+/+` topic filter. Through regular expression replacement, it actually subscribes to or publishes to the topic: `aa/1/2/3`.
- `a/1/2/3/4` does not match any topic rewriting rules.


By default, this plugin is not enabled. To activate it, you must add the `rmqtt-topic-rewrite` entry to the
`plugins.default_startups` configuration in the main configuration file `rmqtt.toml`, as shown below:
```bash
##--------------------------------------------------------------------
## Plugins
##--------------------------------------------------------------------
#Plug in configuration file directory
plugins.dir = "rmqtt-plugins/"
#Plug in started by default, when the mqtt server is started
plugins.default_startups = [
    #"rmqtt-retainer",
    #"rmqtt-auth-http",
    #"rmqtt-cluster-broadcast",
    #"rmqtt-cluster-raft",
    #"rmqtt-sys-topic",
    #"rmqtt-message-storage",
    #"rmqtt-session-storage",
    "rmqtt-topic-rewrite",
    "rmqtt-web-hook",
    "rmqtt-http-api"
]
```

